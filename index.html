<!DOCTYPE html>
<html>
    <head>
        <title>Mocs Express Route</title>
        <meta charset='utf-8' />
        <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
        <script src="https://unpkg.com/maplibre-gl@^4.7.1/dist/maplibre-gl.js"></script>
        <link href="https://unpkg.com/maplibre-gl@^4.7.1/dist/maplibre-gl.css" rel="stylesheet" />

        <!-- font -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">

        <style>
            * {
                font-family: "Inter", sans-serif;
                font-optical-sizing: auto;
                font-style: normal;
            }

            body {
                margin: 0;
                padding: 0;
            }

            .maplibregl-popup-content {
                white-space: pre-line;
            }

            #app {
                bottom: 0;
                left: 0;
                right: 0;
                position: absolute;
                top: 0;
            }
            #map {
                bottom: 30px;
                left: 0;
                right: 0;
                position: absolute;
                top: 56px;                
            }

            #footer {
                background: #004360;
                bottom: 0;
                height: 30px;
                position: absolute;
                width: 100%;
                z-index: 99;
            }

            #footer-text {
                color: lightgray;
                left: 10px;
                position: absolute;
                top: 50%;
                transform: translateY(-50%);
            }

            #header {
                background-color: #edf2f7;
                display: block;
                height: 56px;
                position: relative;
                width: 100%;
                z-index: 99;
            }

            #header #logo1 {
                height: 30px;
                left: 10px;
                position: absolute;
                top: 50%;
                transform: translateY(-50%);
            }
            #header #logo2 {
                height: 30px;
                left: 100px;
                position: absolute;
                top: 50%;
                transform: translateY(-50%);
                width: 165px;
            }            

            #header #text {
                /* font-size: 16px;
                font-weight: 400;
                letter-spacing: .32px; */


                left: 300px;
                position: absolute;
                color: #0b5a82;
                top: 50%;
                transform: translateY(-50%);
            }

            #pagename {
                display: inline-block;
                font-size: 26px;
                font-weight: bold;
            }

            #warning {
                display: inline-block;
                color: black;
                font-weight: bold;
                margin-left: 15px;
            }
            #warning-mobile-inner {
                left: 15px;
                position: absolute;
                top: 50%;
                transform: translateY(-50%);
            }

            @media screen and (max-width: 800px) {
                #footer {
                    font-size: 12px;
                }

                #logo1, #logo2 {
                    display: none;
                }
                #header #text {
                    left: 15px;
                }

                /* #warning {
                    display: none;
                }
                #warning-mobile {
                    background: #004360;
                    height: 30px;
                    left: 0;
                    padding-left: 10px;
                    position: absolute;
                    right: 0;
                    top: 56px;
                    width: 100%;
                } */
            }

            .marker {
                border: 2px solid #004360;
                /* background: #00A3BD; */
                border-radius: 26px;
                cursor: pointer;
                height: 26px;
                text-align: center;
                width: 26px;
            }
            .marker:hover {
                height: 32px;
                width: 32px;
            }
            .marker-inner {
                background: rgb(253, 183, 54);
                border-radius: 25px;
                height: 25px;
                left: 50%;
                position: absolute;
                top: 50%;
                transform: translate(-50%, -50%);
                width: 25px;
            }
            .marker-inner-power {
                background: transparent;
                height: 30px;
                left: 50%;
                position: absolute;
                top: 50%;
                transform: translate(-50%, -50%);
                width: 30px;
            }

            .router-inner {
                background: #f7b204;
                border-radius: 0;
                height: 25px;
                width: 25px;
            }
            .router {
                border: 2px solid #cb9712;
                border-radius: 0;
                height: 25px;
                width: 25px;
            }
            .router[data-description=CAV] {
                border-color: rgb(42, 80, 5);
            }

            .router[data-description=CAV] .router-inner {
                background: rgb(126, 214, 39);
            }
            .marker-inner-text {
                font-size: 10px;
                left: 50%;
                position: absolute;
                transform: translate(-50%, -50%);
                top: 50%;
            }

            .bus-inner img {
                height: 15px;
                left: 50%;
                position: absolute;
                top: 50%;
                transform: translate(-50%, -50%);
                width: 15px;
            }

    </style>
        <script>
            window.app = {
                config: {
                    buses: "/.netlify/functions/buses",
                    routes: "https://gocarta.s3.us-east-2.amazonaws.com/public/data/simple_bus_routes/v1/data.lines.geojson" 
                },
                data: {
                    buses: null
                },
                state: {
                    markers: {
                        buses: null
                    }
                }
            };
        </script>
    </head>
    <body>
        <div id="app">
            <div id="header">
                <a href="https://www.gocarta.org/"><img id="logo1" src="./assets/img/carta-logo.webp" alt="CARTA logo"></a>
                <a href="https://www.gocarta.org/"><img id="logo2" src="./assets/img/utc-horizontal-web.svg" alt="UTC logo"></a>
                <div id="text">
                    <div id="pagename">Mocs Express</div>
                </div>
            </div>
            <div id="map"></div>
            <div id="footer">
                <div id="footer-text">
                    Built by CARTA with MapLibreGL.
                </div>
            </div>
        </div>
        <script>
            var mapOptions = {
                container: 'map', // container id
                // Define the map syle (OpenStreetMap raster tiles)
                style: "https://api.maptiler.com/maps/streets-v2-light/style.json?key=mYniYTe7rfEM5jAFdfKy",
                center: [-85.310947, 35.055666], // starting position [lng, lat]
                zoom: 11 // starting zoom
            };

            // zoom out more if on mobile
            if (window.innerWidth < 800) {
                mapOptions.zoom = 9;
                mapOptions.attributionControl = false;
            }

            var map = new maplibregl.Map(mapOptions);

            if (window.innerWidth < 800) {
                map.addControl(new maplibregl.AttributionControl({ compact: true }), 'bottom-right');
            }

            (async function update_routes () {
                const res = await fetch(window.app.config.routes);
                const routes_geojson = await res.json();
                console.log(routes_geojson);
                const mocs_express_route = routes_geojson.features.find(feature => feature.properties.name.toUpperCase() === "MOCS EXPRESS");

                map.addSource('mocs-express-route', {
                    'type': 'geojson',
                    'data': mocs_express_route
                });

                map.addLayer({
                    'id': 'mocs-express-route-layer',
                    'type': 'line',
                    'source': 'mocs-express-route',
                    'layout': {
                        'line-join': 'round',
                        'line-cap': 'round'
                    },
                    'paint': {
                        'line-color': "#FFB81C",
                        'line-width': 3,
                    }
                });              
            })();

            async function update_buses () {
                console.log("updating buses");
                const res = await fetch(window.app.config.buses);
                app.data.buses = await res.json();

                if (app.state.markers.buses) {
                    app.state.markers.buses.forEach(marker => {
                        marker.remove();
                    });
                }
                app.state.markers.buses = [];

                const buses = app.data.buses.features;
                for (let i = 0; i < buses.length; i++) {
                    const bus = buses[i];

                    const point = bus.geometry.coordinates;  
                    if (!point) continue;

                    // create a DOM element for the marker
                    const el = document.createElement('div');
                    el.className = "marker bus";
                    el.innerHTML = `<div class="marker-inner bus-inner"><div class="marker-inner-text">${bus.properties.vehicleId}</div></div>`;

                    const marker = new maplibregl.Marker( { element: el }).setLngLat(point).addTo(map);

                    app.state.markers.buses.push(marker);
                }
            }

            update_buses();
            setInterval(function () {
                update_buses();
            }, 10 * 1000);
        </script>
    </body>
</html>